<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg: #f3f6fb;
        --surface: #ffffff;
        --text: #0b1321;
        --muted: #5a687d;
        --accent: #1f6feb;
        --ok: #0f8f3c;
        --warn: #c97400;
        --border: #d9e1ec;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
        color: var(--text);
        background: linear-gradient(180deg, #f7f9fd 0%, #edf3fb 100%);
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }
      h1 { margin: 0 0 8px; font-size: 30px; }
      .sub { color: var(--muted); margin-bottom: 20px; }
      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 16px;
      }
      .card {
        grid-column: span 12;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
      }
      label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
      input, select, button {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 8px;
        min-height: 40px;
        padding: 8px 10px;
        font-size: 14px;
      }
      button {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: white;
        color: var(--text);
        border-color: var(--border);
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 10px;
      }
      .metric {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
      }
      .metric .k { font-size: 11px; color: var(--muted); }
      .metric .v { font-size: 18px; font-weight: 700; margin-top: 2px; }
      .metric .v.pos { color: var(--ok); }
      .metric .v.neg { color: #b42318; }
      .insight-list {
        margin: 0;
        padding-left: 18px;
      }
      .insight-list li {
        margin: 6px 0;
      }
      .split {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 20px;
      }
      .header-actions {
        display: flex;
        gap: 8px;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(4, 10, 20, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .modal.open { display: flex; }
      .modal-panel {
        width: min(560px, calc(100vw - 24px));
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
      }
      .mini { font-size: 12px; color: var(--muted); }
      .links {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .links a {
        text-decoration: none;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        color: var(--text);
        background: #fff;
      }
      .canvas-wrap {
        width: 100%;
        min-height: 280px;
        height: 320px;
        position: relative;
      }
      .canvas-wrap canvas {
        width: 100% !important;
        height: 100% !important;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th, td {
        border-bottom: 1px solid var(--border);
        padding: 8px 6px;
        text-align: left;
      }
      th { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.02em; }
      .status { font-size: 13px; color: var(--muted); margin-top: 10px; }
      .ok { color: var(--ok); }
      .warn { color: var(--warn); }
      @media (max-width: 1000px) {
        .row, .metrics, .split { grid-template-columns: 1fr 1fr; }
      }
      @media (max-width: 640px) {
        .row, .metrics, .split { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header-row">
        <div>
          <h1>Portfolio Analytics</h1>
          <div class="sub">Compare followed companies from providers directly, or upload trades for full portfolio analytics.</div>
        </div>
        <div class="header-actions">
          <button id="openSettings" class="secondary">Settings</button>
          <button id="runAll">Run Full Analysis</button>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <h3>Backend Connection</h3>
          <div class="row">
            <div>
              <label>API Base URL (from Settings)</label>
              <input id="apiBaseDisplay" value="" disabled />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="checkHealth" class="secondary">Check Health</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="loadData">Run Analysis</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="refreshPrices" class="secondary">Refresh Prices</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="compareCompanies" class="secondary">Compare Companies</button>
            </div>
          </div>
          <div id="connStatus" class="status">Not checked yet.</div>
        </section>

        <section class="card">
          <h3>Trade Import</h3>
          <div class="links" style="margin-bottom:10px;">
            <a href="https://github.com/joru10/portfolio-analytics-platform/blob/main/sample-data/trades_seed.csv" target="_blank">Sample: seed CSV</a>
            <a href="https://github.com/joru10/portfolio-analytics-platform/blob/main/sample-data/trades_incremental.csv" target="_blank">Sample: incremental CSV</a>
            <a href="https://github.com/joru10/portfolio-analytics-platform/blob/main/sample-data/trades_seed.xlsx" target="_blank">Sample: seed XLSX</a>
          </div>
          <div class="row">
            <div>
              <label for="tradeFile">CSV/XLSX File</label>
              <input id="tradeFile" type="file" accept=".csv,.xlsx" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="importTrades">Import Trades</button>
            </div>
            <div>
              <label for="snapshotDate">Snapshot Date</label>
              <input id="snapshotDate" type="date" />
            </div>
            <div>
              <label for="account">Account (optional)</label>
              <input id="account" placeholder="ACC1" />
            </div>
            <div>
              <label for="lookbackDays">Lookback Days</label>
              <input id="lookbackDays" type="number" min="30" step="30" value="180" />
            </div>
          </div>
          <div id="importStatus" class="status"></div>
        </section>

        <section class="card">
          <h3>Metrics</h3>
          <div id="metrics" class="metrics"></div>
        </section>

        <section class="card">
          <h3>Insights</h3>
          <ul id="insights" class="insight-list"></ul>
        </section>

        <section class="card">
          <h3>Analysis Breakdown</h3>
          <div class="split">
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Top Movers</th><th>Total PnL</th><th>Mkt Value</th><th>Weight %</th>
                  </tr>
                </thead>
                <tbody id="moversBody"></tbody>
              </table>
            </div>
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Account</th><th>Mkt Value</th><th>Unrealized</th><th>Realized</th>
                  </tr>
                </thead>
                <tbody id="accountsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="card">
          <h3>Charts</h3>
          <div class="split" style="margin-bottom: 12px;">
            <div class="canvas-wrap"><canvas id="allocationChart"></canvas></div>
            <div class="canvas-wrap"><canvas id="pnlChart"></canvas></div>
          </div>
          <div class="split">
            <div class="canvas-wrap"><canvas id="equityChart"></canvas></div>
            <div class="canvas-wrap"><canvas id="drawdownChart"></canvas></div>
          </div>
        </section>

        <section id="compareSection" class="card">
          <h3>Company Compare (No Upload Required)</h3>
          <div class="mini" style="margin-bottom: 10px;">
            Uses symbols from Settings -> Companies to Follow and fetches historical prices via selected providers.
          </div>
          <div class="split" style="margin-bottom: 12px;">
            <div class="canvas-wrap"><canvas id="compareNormalizedChart"></canvas></div>
            <div class="canvas-wrap"><canvas id="compareReturnChart"></canvas></div>
          </div>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Symbol</th><th>Start</th><th>End</th><th>Total Return %</th><th>Ann. Vol %</th><th>Max DD %</th><th>Obs</th>
                </tr>
              </thead>
              <tbody id="compareBody"></tbody>
            </table>
          </div>
          <div class="split" style="margin-top: 12px;">
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr><th>Leaderboard</th><th>Return %</th><th>Ann. Vol %</th><th>Max DD %</th></tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
              </table>
            </div>
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr><th>Pair</th><th>Correlation</th></tr>
                </thead>
                <tbody id="correlationBody"></tbody>
              </table>
            </div>
          </div>
          <div id="compareStatus" class="status"></div>
        </section>

        <section class="card">
          <h3>Advanced Compare Analytics</h3>
          <div class="split" style="margin-bottom: 12px;">
            <div class="canvas-wrap"><canvas id="rollingVolChart"></canvas></div>
            <div class="canvas-wrap"><canvas id="relativeStrengthChart"></canvas></div>
          </div>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr><th>Symbol</th><th>Momentum 20d %</th><th>Vol 20d (ann. %) </th><th>Drawdown 60d %</th><th>Regime</th></tr>
              </thead>
              <tbody id="regimeBody"></tbody>
            </table>
          </div>
          <div id="advancedStatus" class="status"></div>
        </section>

        <section class="card">
          <h3>Positions</h3>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Account</th><th>Symbol</th><th>Qty</th><th>Avg Cost</th><th>Mkt Price</th><th>Mkt Value</th><th>Unrealized</th><th>Realized</th>
                </tr>
              </thead>
              <tbody id="positionsBody"></tbody>
            </table>
          </div>
          <div id="positionsStatus" class="status"></div>
        </section>
      </div>
    </div>

    <div id="settingsModal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-panel">
        <h3 style="margin-top:0;">App Settings</h3>
        <div class="mini" style="margin-bottom: 10px;">Stored in this browser so end users set once and forget.</div>
        <div class="row">
          <div style="grid-column: span 3;">
            <label for="apiBaseInput">API Base URL</label>
            <input id="apiBaseInput" placeholder="https://your-backend.example.com" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="saveSettings">Save</button>
          </div>
        </div>
        <div class="row" style="margin-top: 10px;">
          <div style="grid-column: span 2;">
            <label for="providersInput">Providers Priority (comma-separated)</label>
            <input id="providersInput" placeholder="demo, yfinance" />
          </div>
          <div style="grid-column: span 2;">
            <label for="followedInput">Companies to Follow (symbols, comma-separated)</label>
            <input id="followedInput" placeholder="AAPL, MSFT, BLAIZE" />
          </div>
        </div>
        <div class="mini" style="margin-top:8px;">Example temporary URL: `https://cities-gps-maybe-menus.trycloudflare.com`</div>
        <div style="display:flex; justify-content:flex-end; margin-top: 12px;">
          <button id="closeSettings" class="secondary">Close</button>
        </div>
      </div>
    </div>

    <script>
      const byId = (id) => document.getElementById(id);
      const fmt = (v) => (v === null || v === undefined ? "-" : Number(v).toLocaleString(undefined, { maximumFractionDigits: 4 }));
      const num = (v) => (v === null || v === undefined ? 0 : Number(v));
      const cls = (v) => (num(v) > 0 ? "pos" : num(v) < 0 ? "neg" : "");
      const STORE_KEY = "portfolio_api_base_url";
      const STORE_PROVIDERS_KEY = "portfolio_providers";
      const STORE_FOLLOWED_KEY = "portfolio_followed_symbols";
      const BENCHMARK_SYMBOL = "SPY";
      let allocationChart;
      let pnlChart;
      let equityChart;
      let drawdownChart;
      let compareNormalizedChart;
      let compareReturnChart;
      let rollingVolChart;
      let relativeStrengthChart;

      function getBase() {
        const val = (localStorage.getItem(STORE_KEY) || "").trim();
        return val || window.location.origin;
      }

      function queryParams() {
        const p = new URLSearchParams();
        const snapshotDate = byId("snapshotDate").value;
        const account = byId("account").value.trim();
        const lookbackDays = Number(byId("lookbackDays").value || 180);
        if (snapshotDate) p.set("snapshot_date", snapshotDate);
        if (account) p.set("account", account);
        if (snapshotDate && lookbackDays > 0) {
          const d = new Date(snapshotDate + "T00:00:00");
          d.setDate(d.getDate() - lookbackDays);
          p.set("start_date", d.toISOString().slice(0, 10));
        }
        return p.toString();
      }

      async function request(path, options = {}) {
        const url = `${getBase()}${path}`;
        const res = await fetch(url, options);
        const body = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(body.detail || `Request failed: ${res.status}`);
        return body;
      }

      async function checkHealth() {
        const node = byId("connStatus");
        try {
          const health = await request("/health");
          node.innerHTML = `Health: <span class="ok">${health.status}</span>`;
        } catch (err) {
          node.innerHTML = `<span class="warn">${err.message}</span>`;
        }
      }

      async function importTrades() {
        const status = byId("importStatus");
        const file = byId("tradeFile").files[0];
        if (!file) {
          status.innerHTML = '<span class="warn">Choose a trade file first.</span>';
          return;
        }
        const form = new FormData();
        form.append("file", file);
        try {
          const payload = await request("/v1/trades/import", { method: "POST", body: form });
          status.innerHTML = `Imported ${payload.imported_rows}/${payload.total_rows} rows, duplicates: ${payload.duplicate_rows}. Run Analysis next.`;
        } catch (err) {
          status.innerHTML = `<span class="warn">${err.message}</span>`;
        }
      }

      async function refreshPrices() {
        const status = byId("connStatus");
        const snapshotDate = byId("snapshotDate").value || new Date().toISOString().slice(0, 10);
        const followedSymbols = getFollowedSymbols();
        const providers = getSelectedProviders();
        try {
          const payload = await request("/v1/prices/refresh", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ price_date: snapshotDate, symbols: followedSymbols, providers })
          });
          status.innerHTML = `Prices refreshed (${payload.processed_count}/${payload.requested_count}), providers: ${payload.providers_used.join(" → ")}, failures: ${payload.failed_symbols.length}`;
          return payload;
        } catch (err) {
          status.innerHTML = `<span class="warn">${err.message}</span>`;
          throw err;
        }
      }

      function getSelectedProviders() {
        const raw = localStorage.getItem(STORE_PROVIDERS_KEY);
        if (!raw) return ["demo"];
        const providers = raw
          .split(",")
          .map((x) => x.trim().toLowerCase())
          .filter(Boolean);
        return providers.length ? providers : ["demo"];
      }

      function getFollowedSymbols() {
        const raw = localStorage.getItem(STORE_FOLLOWED_KEY) || "";
        return raw
          .split(",")
          .map((x) => x.trim().toUpperCase())
          .filter(Boolean);
      }

      function renderCharts(rows, analytics) {
        const topByValue = [...rows]
          .map((r) => ({ symbol: r.symbol, value: num(r.market_value) }))
          .filter((x) => x.value > 0)
          .sort((a, b) => b.value - a.value)
          .slice(0, 7);

        const pnlBySymbol = [...rows]
          .map((r) => ({ symbol: r.symbol, pnl: num(r.unrealized_pnl) + num(r.realized_pnl) }))
          .sort((a, b) => b.pnl - a.pnl);

        const allocCtx = byId("allocationChart").getContext("2d");
        const pnlCtx = byId("pnlChart").getContext("2d");
        const equityCtx = byId("equityChart").getContext("2d");
        const drawdownCtx = byId("drawdownChart").getContext("2d");
        if (allocationChart) allocationChart.destroy();
        if (pnlChart) pnlChart.destroy();
        if (equityChart) equityChart.destroy();
        if (drawdownChart) drawdownChart.destroy();

        allocationChart = new Chart(allocCtx, {
          type: "doughnut",
          data: {
            labels: topByValue.map((x) => x.symbol),
            datasets: [{ data: topByValue.map((x) => x.value) }]
          },
          options: {
            plugins: { title: { display: true, text: "Top Exposure Allocation" } }
          }
        });

        pnlChart = new Chart(pnlCtx, {
          type: "bar",
          data: {
            labels: pnlBySymbol.map((x) => x.symbol),
            datasets: [{
              label: "Total PnL",
              data: pnlBySymbol.map((x) => x.pnl),
              backgroundColor: pnlBySymbol.map((x) => x.pnl >= 0 ? "#0f8f3c" : "#b42318")
            }]
          },
          options: {
            plugins: { title: { display: true, text: "PnL by Symbol" } },
            scales: { y: { beginAtZero: true } }
          }
        });

        const labels = (analytics.series || []).map((p) => p.date);
        const equity = (analytics.series || []).map((p) => p.market_value);
        const drawdowns = (analytics.series || []).map((p) => p.drawdown * 100);

        equityChart = new Chart(equityCtx, {
          type: "line",
          data: {
            labels,
            datasets: [{ label: "Market Value", data: equity, borderColor: "#1f6feb", backgroundColor: "rgba(31,111,235,0.12)", fill: true }]
          },
          options: {
            plugins: { title: { display: true, text: "Equity Curve" } },
            scales: { y: { beginAtZero: false } }
          }
        });

        drawdownChart = new Chart(drawdownCtx, {
          type: "line",
          data: {
            labels,
            datasets: [{ label: "Drawdown %", data: drawdowns, borderColor: "#b42318", backgroundColor: "rgba(180,35,24,0.12)", fill: true }]
          },
          options: {
            plugins: { title: { display: true, text: "Drawdown Curve" } },
            scales: { y: { beginAtZero: false } }
          }
        });
      }

      function stddev(values) {
        if (!values || values.length < 2) return 0;
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        const variance = values.reduce((a, b) => a + ((b - avg) ** 2), 0) / (values.length - 1);
        return Math.sqrt(variance);
      }

      function maxDrawdown(prices) {
        if (!prices || !prices.length) return 0;
        let peak = prices[0];
        let maxDd = 0;
        for (const px of prices) {
          peak = Math.max(peak, px);
          if (peak > 0) maxDd = Math.min(maxDd, (px / peak) - 1);
        }
        return maxDd;
      }

      function latestN(values, n) {
        return values.length <= n ? values : values.slice(values.length - n);
      }

      function buildRegimeRows(series, symbols) {
        const rows = [];
        for (const symbol of symbols) {
          const prices = series.map((p) => p.prices?.[symbol]).filter((x) => x !== null && x !== undefined);
          if (prices.length < 25) {
            rows.push({ symbol, mom20: null, vol20: null, dd60: null, regime: "Insufficient Data" });
            continue;
          }

          const last = prices[prices.length - 1];
          const p20 = prices[prices.length - 21];
          const mom20 = p20 > 0 ? (last / p20) - 1 : null;

          const returns = [];
          for (let i = 1; i < prices.length; i += 1) {
            const prev = prices[i - 1];
            const cur = prices[i];
            if (prev > 0) returns.push((cur / prev) - 1);
          }
          const vol20 = returns.length >= 20 ? stddev(latestN(returns, 20)) * Math.sqrt(252) : null;
          const dd60 = maxDrawdown(latestN(prices, 60));

          let regime = "Neutral";
          if (mom20 === null || vol20 === null) regime = "Insufficient Data";
          else if (mom20 > 0.05 && vol20 < 0.40) regime = "Risk-On";
          else if (mom20 < -0.05 || dd60 < -0.20) regime = "Risk-Off";

          rows.push({ symbol, mom20, vol20, dd60, regime });
        }
        return rows;
      }

      function renderAdvancedCompare(payload, trackedSymbols) {
        const series = payload.series || [];
        const symbols = trackedSymbols.length ? trackedSymbols : (payload.symbols || []).filter((s) => s !== BENCHMARK_SYMBOL);
        const labels = series.map((p) => p.date);
        const status = byId("advancedStatus");
        const regimeBody = byId("regimeBody");

        const volCtx = byId("rollingVolChart").getContext("2d");
        const rsCtx = byId("relativeStrengthChart").getContext("2d");
        if (rollingVolChart) rollingVolChart.destroy();
        if (relativeStrengthChart) relativeStrengthChart.destroy();

        if (!series.length || !symbols.length) {
          regimeBody.innerHTML = "";
          status.innerHTML = '<span class="warn">Advanced analytics unavailable: no series/symbols.</span>';
          return;
        }

        const colors = ["#1f6feb", "#0f8f3c", "#b42318", "#c97400", "#6f42c1", "#0077aa", "#ef4444", "#14b8a6"];
        const volDatasets = symbols.map((symbol, idx) => {
          const prices = series.map((p) => p.prices?.[symbol]);
          const returns = prices.map((_, i) => {
            if (i === 0) return null;
            const prev = prices[i - 1];
            const cur = prices[i];
            if (prev === null || prev === undefined || cur === null || cur === undefined || prev <= 0) return null;
            return (cur / prev) - 1;
          });
          const rollingVol = returns.map((_, i) => {
            const window = returns.slice(Math.max(1, i - 19), i + 1).filter((x) => x !== null && x !== undefined);
            if (window.length < 15) return null;
            return stddev(window) * Math.sqrt(252) * 100;
          });
          return {
            label: symbol,
            data: rollingVol,
            borderColor: colors[idx % colors.length],
            backgroundColor: "transparent",
            tension: 0.2,
          };
        });

        rollingVolChart = new Chart(volCtx, {
          type: "line",
          data: { labels, datasets: volDatasets },
          options: {
            plugins: { title: { display: true, text: "Rolling Volatility (20d, Annualized %)" } },
            scales: { y: { beginAtZero: true } },
          },
        });

        const benchmarkAvailable = (payload.symbols || []).includes(BENCHMARK_SYMBOL);
        const rsDatasets = benchmarkAvailable
          ? symbols.map((symbol, idx) => ({
              label: `${symbol} vs ${BENCHMARK_SYMBOL}`,
              data: series.map((p) => {
                const sym = p.normalized?.[symbol];
                const bm = p.normalized?.[BENCHMARK_SYMBOL];
                if (sym === null || sym === undefined || bm === null || bm === undefined || bm === 0) return null;
                return ((sym / bm) - 1) * 100;
              }),
              borderColor: colors[idx % colors.length],
              backgroundColor: "transparent",
              tension: 0.2,
            }))
          : [];

        relativeStrengthChart = new Chart(rsCtx, {
          type: "line",
          data: { labels, datasets: rsDatasets },
          options: {
            plugins: { title: { display: true, text: `Relative Strength vs ${BENCHMARK_SYMBOL} (%)` } },
            scales: { y: { beginAtZero: false } },
          },
        });

        const regimeRows = buildRegimeRows(series, symbols);
        regimeBody.innerHTML = regimeRows
          .map((r) => `
            <tr>
              <td>${r.symbol}</td>
              <td class="${cls((r.mom20 || 0) * 100)}">${r.mom20 === null ? "-" : fmt(r.mom20 * 100)}</td>
              <td>${r.vol20 === null ? "-" : fmt(r.vol20 * 100)}</td>
              <td class="${cls((r.dd60 || 0) * 100)}">${r.dd60 === null ? "-" : fmt(r.dd60 * 100)}</td>
              <td>${r.regime}</td>
            </tr>
          `)
          .join("");

        status.innerHTML = benchmarkAvailable
          ? `Advanced analytics ready for ${symbols.length} symbols vs ${BENCHMARK_SYMBOL}.`
          : `<span class="warn">${BENCHMARK_SYMBOL} benchmark unavailable from providers; relative strength chart may be empty.</span>`;
      }

      function renderCompanyCompare(payload) {
        const symbols = payload.symbols || [];
        const trackedSymbols = symbols.filter((s) => s !== BENCHMARK_SYMBOL);
        const series = payload.series || [];
        const summary = payload.summary || [];
        const compareBody = byId("compareBody");
        const leaderboardBody = byId("leaderboardBody");
        const correlationBody = byId("correlationBody");
        const compareStatus = byId("compareStatus");
        const connStatus = byId("connStatus");
        const metricsNode = byId("metrics");
        const insightsNode = byId("insights");

        compareBody.innerHTML = summary
          .map((s) => `
            <tr>
              <td>${s.symbol === BENCHMARK_SYMBOL ? `${s.symbol} (Benchmark)` : s.symbol}</td>
              <td>${fmt(s.start_price)}</td>
              <td>${fmt(s.end_price)}</td>
              <td class="${cls(s.return_pct * 100)}">${fmt((s.return_pct || 0) * 100)}</td>
              <td>${fmt((s.annualized_volatility || 0) * 100)}</td>
              <td class="${cls(s.max_drawdown * 100)}">${fmt((s.max_drawdown || 0) * 100)}</td>
              <td>${fmt(s.observations)}</td>
            </tr>
          `)
          .join("");

        leaderboardBody.innerHTML = [...summary]
          .sort((a, b) => (b.return_pct || 0) - (a.return_pct || 0))
          .map((s) => `
            <tr>
              <td>${s.symbol}</td>
              <td class="${cls((s.return_pct || 0) * 100)}">${fmt((s.return_pct || 0) * 100)}</td>
              <td>${fmt((s.annualized_volatility || 0) * 100)}</td>
              <td class="${cls((s.max_drawdown || 0) * 100)}">${fmt((s.max_drawdown || 0) * 100)}</td>
            </tr>
          `)
          .join("");

        const pairs = [];
        const corr = payload.correlation || {};
        for (const left of symbols) {
          for (const right of symbols) {
            if (left >= right) continue;
            const value = corr[left] && corr[left][right] !== undefined ? corr[left][right] : null;
            pairs.push({ pair: `${left} vs ${right}`, value });
          }
        }
        correlationBody.innerHTML = pairs.length
          ? pairs
              .sort((a, b) => Math.abs(num(b.value)) - Math.abs(num(a.value)))
              .map((p) => `<tr><td>${p.pair}</td><td>${fmt(p.value)}</td></tr>`)
              .join("")
          : `<tr><td colspan="2">Not enough symbols for pairwise correlation.</td></tr>`;

        const labels = series.map((p) => p.date);
        const normalizedCtx = byId("compareNormalizedChart").getContext("2d");
        const returnCtx = byId("compareReturnChart").getContext("2d");
        if (compareNormalizedChart) compareNormalizedChart.destroy();
        if (compareReturnChart) compareReturnChart.destroy();

        const colors = ["#1f6feb", "#0f8f3c", "#b42318", "#c97400", "#6f42c1", "#0077aa", "#8b5cf6", "#ef4444"];
        compareNormalizedChart = new Chart(normalizedCtx, {
          type: "line",
          data: {
            labels,
            datasets: symbols.map((symbol, idx) => ({
              label: symbol,
              data: series.map((p) => (p.normalized?.[symbol] !== null && p.normalized?.[symbol] !== undefined ? (p.normalized[symbol] - 1) * 100 : null)),
              borderColor: colors[idx % colors.length],
              backgroundColor: "transparent",
              tension: 0.2,
            })),
          },
          options: {
            plugins: { title: { display: true, text: "Relative Performance (% from first point)" } },
            scales: { y: { beginAtZero: false } },
          },
        });

        compareReturnChart = new Chart(returnCtx, {
          type: "bar",
          data: {
            labels: summary.map((s) => s.symbol),
            datasets: [
              {
                label: "Total Return %",
                data: summary.map((s) => (s.return_pct || 0) * 100),
                backgroundColor: summary.map((s) => ((s.return_pct || 0) >= 0 ? "#0f8f3c" : "#b42318")),
              },
            ],
          },
          options: {
            plugins: { title: { display: true, text: "Total Return by Symbol" } },
            scales: { y: { beginAtZero: true } },
          },
        });

        if (!series.length) {
          const msg = `No price history returned for the selected symbols/providers/date range. Failed: ${payload.failed_symbols.join(", ") || "n/a"}.`;
          compareStatus.innerHTML = `<span class="warn">${msg}</span>`;
          connStatus.innerHTML = `<span class="warn">${msg}</span>`;
          leaderboardBody.innerHTML = "";
          correlationBody.innerHTML = "";
          byId("regimeBody").innerHTML = "";
          byId("advancedStatus").innerHTML = "";
          if (rollingVolChart) rollingVolChart.destroy();
          if (relativeStrengthChart) relativeStrengthChart.destroy();
          return;
        }

        const returns = summary.map((s) => Number(s.return_pct || 0));
        const vols = summary.map((s) => Number(s.annualized_volatility || 0));
        const dds = summary.map((s) => Number(s.max_drawdown || 0));
        const avgReturn = returns.length ? returns.reduce((a, b) => a + b, 0) / returns.length : 0;
        const avgVol = vols.length ? vols.reduce((a, b) => a + b, 0) / vols.length : 0;
        const worstDd = dds.length ? Math.min(...dds) : 0;
        const best = [...summary].sort((a, b) => (b.return_pct || 0) - (a.return_pct || 0))[0];
        const worst = [...summary].sort((a, b) => (a.return_pct || 0) - (b.return_pct || 0))[0];

        metricsNode.innerHTML = [
          ["Compare Symbols", trackedSymbols.length || symbols.length],
          ["Data Points", series.length],
          ["Avg Return %", fmt(avgReturn * 100)],
          ["Avg Ann. Vol %", fmt(avgVol * 100)],
          ["Worst Drawdown %", fmt(worstDd * 100)],
        ]
          .map(([k, v]) => `<div class="metric"><div class="k">${k}</div><div class="v ${cls(v)}">${v}</div></div>`)
          .join("");

        insightsNode.innerHTML = [
          `Compared ${(trackedSymbols.length ? trackedSymbols : symbols).join(", ")} from ${payload.start_date} to ${payload.end_date}.`,
          best ? `Best performer: ${best.symbol} (${fmt((best.return_pct || 0) * 100)}%).` : "Best performer unavailable.",
          worst ? `Worst performer: ${worst.symbol} (${fmt((worst.return_pct || 0) * 100)}%).` : "Worst performer unavailable.",
          `Providers used: ${payload.providers_used.join(" → ")}.`,
          payload.failed_symbols.length ? `Failed symbols: ${payload.failed_symbols.join(", ")}.` : "No symbol failures.",
        ]
          .map((x) => `<li>${x}</li>`)
          .join("");

        const msg = `Compared ${(trackedSymbols.length || symbols.length)} symbols (${series.length} points) from ${payload.start_date} to ${payload.end_date} using providers: ${payload.providers_used.join(" → ")}${symbols.includes(BENCHMARK_SYMBOL) ? ` + benchmark ${BENCHMARK_SYMBOL}` : ""}${payload.failed_symbols.length ? `. Failed: ${payload.failed_symbols.join(", ")}` : ""}.`;
        compareStatus.innerHTML = msg;
        connStatus.innerHTML = msg;
        renderAdvancedCompare(payload, trackedSymbols);
      }

      async function runCompanyCompare() {
        const status = byId("compareStatus");
        const followedSymbols = getFollowedSymbols();
        const requestSymbols = [...followedSymbols];
        if (!requestSymbols.includes(BENCHMARK_SYMBOL)) requestSymbols.push(BENCHMARK_SYMBOL);
        const providers = getSelectedProviders();
        const endDate = byId("snapshotDate").value || new Date().toISOString().slice(0, 10);
        const lookbackDays = Number(byId("lookbackDays").value || 180);

        if (!followedSymbols.length) {
          status.innerHTML = '<span class="warn">Set companies to follow in Settings first (e.g., AAPL, MSFT, BLAIZE).</span>';
          byId("compareBody").innerHTML = "";
          byId("leaderboardBody").innerHTML = "";
          byId("correlationBody").innerHTML = "";
          byId("regimeBody").innerHTML = "";
          byId("advancedStatus").innerHTML = "";
          if (compareNormalizedChart) compareNormalizedChart.destroy();
          if (compareReturnChart) compareReturnChart.destroy();
          if (rollingVolChart) rollingVolChart.destroy();
          if (relativeStrengthChart) relativeStrengthChart.destroy();
          return;
        }

        const start = new Date(`${endDate}T00:00:00`);
        start.setDate(start.getDate() - Math.max(30, lookbackDays));
        const startDate = start.toISOString().slice(0, 10);

        try {
          byId("connStatus").textContent = "Running provider-based company compare...";
          status.textContent = "Running provider-based company compare...";
          const payload = await request("/v1/companies/compare", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              symbols: requestSymbols,
              start_date: startDate,
              end_date: endDate,
              providers,
            }),
          });
          renderCompanyCompare(payload);
          byId("compareSection").scrollIntoView({ behavior: "smooth", block: "start" });
        } catch (err) {
          status.innerHTML = `<span class="warn">${err.message}</span>`;
          byId("connStatus").innerHTML = `<span class="warn">${err.message}</span>`;
          byId("compareBody").innerHTML = "";
          byId("leaderboardBody").innerHTML = "";
          byId("correlationBody").innerHTML = "";
          byId("regimeBody").innerHTML = "";
          byId("advancedStatus").innerHTML = "";
          if (compareNormalizedChart) compareNormalizedChart.destroy();
          if (compareReturnChart) compareReturnChart.destroy();
          if (rollingVolChart) rollingVolChart.destroy();
          if (relativeStrengthChart) relativeStrengthChart.destroy();
          throw err;
        }
      }

      async function loadData() {
        const qs = queryParams();
        const metricsNode = byId("metrics");
        const body = byId("positionsBody");
        const moversBody = byId("moversBody");
        const accountsBody = byId("accountsBody");
        const insights = byId("insights");
        const posStatus = byId("positionsStatus");
        try {
          await refreshPrices();
          const [metrics, positions, analytics] = await Promise.all([
            request(`/v1/metrics${qs ? `?${qs}` : ""}`),
            request(`/v1/positions${qs ? `?${qs}` : ""}`),
            request(`/v1/analytics${qs ? `?${qs}` : ""}`),
          ]);
          const followedSet = new Set(getFollowedSymbols());
          const allRows = positions.positions || [];
          const rows = followedSet.size ? allRows.filter((r) => followedSet.has(String(r.symbol).toUpperCase())) : allRows;
          const totalMkt = rows.reduce((acc, r) => acc + num(r.market_value), 0);
          const unpricedCount = rows.filter((r) => r.market_price === null).length;

          metricsNode.innerHTML = [
            ["Total Positions", metrics.total_positions],
            ["Market Value", fmt(metrics.total_market_value)],
            ["Cost Basis", fmt(metrics.total_cost_basis)],
            ["Unrealized PnL", fmt(metrics.total_unrealized_pnl)],
            ["Realized PnL", fmt(metrics.total_realized_pnl)],
            ["Ann. Volatility", `${fmt((analytics.annualized_volatility || 0) * 100)}%`],
            ["Sharpe Ratio", fmt(analytics.sharpe_ratio)],
            ["Max Drawdown", `${fmt((analytics.max_drawdown || 0) * 100)}%`],
            ["VaR 95 (daily)", `${fmt((analytics.var_95 || 0) * 100)}%`],
            ["CVaR 95 (daily)", `${fmt((analytics.cvar_95 || 0) * 100)}%`],
          ].map(([k, v]) => `<div class="metric"><div class="k">${k}</div><div class="v ${cls(v)}">${v}</div></div>`).join("");

          const movers = rows
            .map((r) => {
              const totalPnl = num(r.unrealized_pnl) + num(r.realized_pnl);
              const market = num(r.market_value);
              const weight = totalMkt > 0 ? (market / totalMkt) * 100 : 0;
              return { symbol: r.symbol, totalPnl, market, weight };
            })
            .sort((a, b) => Math.abs(b.totalPnl) - Math.abs(a.totalPnl))
            .slice(0, 6);

          moversBody.innerHTML = movers.map((m) => `
            <tr>
              <td>${m.symbol}</td>
              <td class="${cls(m.totalPnl)}">${fmt(m.totalPnl)}</td>
              <td>${fmt(m.market)}</td>
              <td>${fmt(m.weight)}</td>
            </tr>
          `).join("");

          const byAccount = {};
          for (const r of rows) {
            byAccount[r.account] = byAccount[r.account] || { market: 0, unrealized: 0, realized: 0 };
            byAccount[r.account].market += num(r.market_value);
            byAccount[r.account].unrealized += num(r.unrealized_pnl);
            byAccount[r.account].realized += num(r.realized_pnl);
          }
          accountsBody.innerHTML = Object.entries(byAccount)
            .sort((a, b) => b[1].market - a[1].market)
            .map(([account, v]) => `
              <tr>
                <td>${account}</td>
                <td>${fmt(v.market)}</td>
                <td class="${cls(v.unrealized)}">${fmt(v.unrealized)}</td>
                <td class="${cls(v.realized)}">${fmt(v.realized)}</td>
              </tr>
            `).join("");

          const largest = rows
            .map((r) => ({ symbol: r.symbol, market: num(r.market_value) }))
            .sort((a, b) => b.market - a.market)[0];
          const largestWeight = largest && totalMkt > 0 ? (largest.market / totalMkt) * 100 : 0;
          const pnlTotal = num(metrics.total_unrealized_pnl) + num(metrics.total_realized_pnl);
          const top = movers[0];

          const insightItems = [
            `Snapshot ${positions.snapshot_date}: ${rows.length} positions analyzed across ${Object.keys(byAccount).length} accounts${followedSet.size ? ` (filtered to followed symbols: ${Array.from(followedSet).join(", ")})` : ""}.`,
            `Portfolio total PnL is ${fmt(pnlTotal)} (${fmt(metrics.total_unrealized_pnl)} unrealized + ${fmt(metrics.total_realized_pnl)} realized).`,
            followedSet.size ? `Metrics cards are portfolio-level; tables/charts are filtered to followed symbols.` : "Metrics/tables/charts all represent the full selected portfolio scope.",
            top ? `Largest PnL mover is ${top.symbol} at ${fmt(top.totalPnl)}.` : "No movers available yet.",
            largest ? `Biggest concentration is ${largest.symbol} at ${fmt(largestWeight)}% of priced market value.` : "No priced exposure yet.",
            unpricedCount > 0 ? `${unpricedCount} symbols have no price for the selected date.` : "All symbols are priced for the selected date.",
            totalMkt > 0 ? `Concentration warning threshold (35%) is ${largestWeight > 35 ? "breached" : "not breached"}.` : "Concentration check unavailable with zero priced market value.",
            analytics.concentration_top_symbol ? `Risk concentration top name: ${analytics.concentration_top_symbol} (${fmt(analytics.concentration_top_weight * 100)}% weight).` : "Risk concentration not available.",
          ];
          insights.innerHTML = insightItems.map((x) => `<li>${x}</li>`).join("");
          renderCharts(rows, analytics);

          body.innerHTML = positions.positions.map((p) => `
            <tr>
              <td>${p.account}</td>
              <td>${p.symbol}</td>
              <td>${fmt(p.quantity)}</td>
              <td>${fmt(p.avg_cost)}</td>
              <td>${fmt(p.market_price)}</td>
              <td>${fmt(p.market_value)}</td>
              <td>${fmt(p.unrealized_pnl)}</td>
              <td>${fmt(p.realized_pnl)}</td>
            </tr>
          `).join("");
          posStatus.textContent = `Snapshot ${positions.snapshot_date}. Rows: ${positions.positions.length}.`;
        } catch (err) {
          metricsNode.innerHTML = "";
          body.innerHTML = "";
          moversBody.innerHTML = "";
          accountsBody.innerHTML = "";
          insights.innerHTML = "";
          if (allocationChart) allocationChart.destroy();
          if (pnlChart) pnlChart.destroy();
          if (equityChart) equityChart.destroy();
          if (drawdownChart) drawdownChart.destroy();
          posStatus.innerHTML = `<span class="warn">${err.message}</span>`;
        }
      }

      function syncSettingsUi() {
        const base = getBase();
        byId("apiBaseDisplay").value = base;
        byId("apiBaseInput").value = localStorage.getItem(STORE_KEY) || "";
        byId("providersInput").value = getSelectedProviders().join(", ");
        byId("followedInput").value = getFollowedSymbols().join(", ");
      }

      function openSettings() {
        byId("settingsModal").classList.add("open");
        syncSettingsUi();
      }

      function closeSettings() {
        byId("settingsModal").classList.remove("open");
      }

      function saveSettings() {
        const val = byId("apiBaseInput").value.trim();
        const providersVal = byId("providersInput").value.trim();
        const followedVal = byId("followedInput").value.trim();
        if (val) localStorage.setItem(STORE_KEY, val);
        else localStorage.removeItem(STORE_KEY);
        if (providersVal) localStorage.setItem(STORE_PROVIDERS_KEY, providersVal);
        else localStorage.removeItem(STORE_PROVIDERS_KEY);
        if (followedVal) localStorage.setItem(STORE_FOLLOWED_KEY, followedVal);
        else localStorage.removeItem(STORE_FOLLOWED_KEY);
        syncSettingsUi();
        closeSettings();
      }

      byId("checkHealth").addEventListener("click", checkHealth);
      byId("importTrades").addEventListener("click", importTrades);
      byId("refreshPrices").addEventListener("click", refreshPrices);
      byId("compareCompanies").addEventListener("click", runCompanyCompare);
      byId("loadData").addEventListener("click", loadData);
      byId("runAll").addEventListener("click", async () => {
        try {
          await runCompanyCompare();
        } catch (err) {
          const compareStatus = byId("compareStatus");
          compareStatus.innerHTML = '<span class="warn">Company compare failed. You can still run portfolio analytics if trades were imported.</span>';
        }
        try {
          await loadData();
        } catch (err) {
          const status = byId("positionsStatus");
          status.innerHTML = '<span class="warn">Portfolio analytics needs imported trades. Company compare still completed.</span>';
        }
      });
      byId("openSettings").addEventListener("click", openSettings);
      byId("closeSettings").addEventListener("click", closeSettings);
      byId("saveSettings").addEventListener("click", saveSettings);

      byId("snapshotDate").value = new Date().toISOString().slice(0, 10);
      if (!localStorage.getItem(STORE_KEY)) {
        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
          if (!window.location.origin.includes(":8000")) localStorage.setItem(STORE_KEY, "http://localhost:8000");
        } else {
          localStorage.setItem(STORE_KEY, "https://portfolio-analytics-api-9nm3.onrender.com");
        }
      }
      if (!localStorage.getItem(STORE_PROVIDERS_KEY)) localStorage.setItem(STORE_PROVIDERS_KEY, "demo, yfinance");
      syncSettingsUi();
    </script>
  </body>
</html>
